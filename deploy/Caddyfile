{
  email {$ACME_EMAIL}
}

# Replace the site address below with your domain or public hostname/IP
# Examples:
# ec2-15-229-77-95.sa-east-1.compute.amazonaws.com
# :80 (for HTTP only)

{$SITE_ADDRESS}
{
  encode zstd gzip

  # Serve the built frontend
  root * /srv/dist

  # Proxy API to Rails backend and strip /api prefix
  @api path /api/*
  uri @api strip_prefix /api
  reverse_proxy @api backend:3000

  # Health endpoint passthrough
  reverse_proxy /up backend:3000

  # SPA fallback: serve static if present, otherwise index.html
  try_files {path} /index.html
  file_server

  # Optional: security headers
  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options nosniff
    X-Frame-Options DENY
    Referrer-Policy no-referrer-when-downgrade
  }
}

