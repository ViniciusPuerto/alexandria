{
  email {$ACME_EMAIL}
}

# Replace the site address below with your domain or public hostname/IP
# Examples:
# ec2-15-229-77-95.sa-east-1.compute.amazonaws.com
# :80 (for HTTP only)

{$SITE_ADDRESS}
{
  encode zstd gzip

  route {
    # API: strip /api prefix and proxy to Rails
    handle_path /api/* {
      reverse_proxy backend:3000
    }

    # Health passthrough (no prefix)
    handle /up {
      reverse_proxy backend:3000
    }

    # Static + SPA fallback
    handle {
      root * /srv/dist
      try_files {path} /index.html
      file_server
    }
  }

  # Optional: security headers
  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options nosniff
    X-Frame-Options DENY
    Referrer-Policy no-referrer-when-downgrade
  }
}

